<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- Preconnect to font domains -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- Preload all font styles -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Domine:wght@400..700&family=Noto+Serif+JP:wght@200..900&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,200..900;1,200..900&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Nunito+Sans:ital,opsz,wght@0,6..12,200..1000;1,6..12,200..1000&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Noto+Sans+Mono:wght@100..900&family=Nunito+Sans:ital,opsz,wght@0,6..12,200..1000;1,6..12,200..1000&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@200..900&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=ZCOOL+QingKe+HuangYou&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Zhi+Mang+Xing&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Long+Cang&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Courier+Prime:ital,wght@0,400;0,700;1,400;1,700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">

    <!-- Fallback for users with JavaScript disabled -->
    <noscript>
        <link href="https://fonts.googleapis.com/css2?family=Domine:wght@400..700&family=Noto+Serif+JP:wght@200..900&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,200..900;1,200..900&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:ital,opsz,wght@0,6..12,200..1000;1,6..12,200..1000&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Mono:wght@100..900&family=Nunito+Sans:ital,opsz,wght@0,6..12,200..1000;1,6..12,200..1000&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@200..900&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=ZCOOL+QingKe+HuangYou&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Zhi+Mang+Xing&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Long+Cang&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
    </noscript>
    <title>grid</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='icons/zi.ico') }}">
    <!-- <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" async></script> -->
    <link  rel="stylesheet" href="{{ url_for('static', filename='css/common.css') }}">
    <link  rel="stylesheet" href="{{ url_for('static', filename='css/flashcard.css') }}">
    <!-- <link  rel="stylesheet" href="{{ url_for('static', filename='css/contextmenu.css') }}"> -->
    <link  rel="stylesheet" href="{{ url_for('static', filename='css/hamburger.css') }}">
    <link  rel="stylesheet" href="{{ url_for('static', filename='css/flashcard.css') }}">
    <link  rel="stylesheet" href="{{ url_for('static', filename='css/grid.css') }}">
    <!-- <link  rel="stylesheet" href="{{ url_for('static', filename='css/flashcard_expanded.css') }}"> -->
    <link  rel="stylesheet" href="{{ url_for('static', filename='css/flashcard.css') }}">
    <script src="{{ url_for('static', filename='js/plotter_better.js') }}" async></script>
    <style id="dynamic-styles">
        
    </style>
    <style>
        @font-face {
            font-family: 'Kaiti';
            font-display: swap;
            src: url("{{ url_for('static', filename='fonts/Kaiti.ttf') }}") format('truetype');
            font-weight: normal;
            font-style: normal;
        }
    </style>

    <style>
        #kaiti-loader {
            font-family: 'Kaiti', sans-serif;
            font-size: 0;
            visibility: hidden;
            position: absolute;
            top: -9999px;
        }
    </style>
    <div id="kaiti-loader">汉字</div>
    
    <style>
        #backLink {
            position: absolute;
            top: 1em;
            left: 1em;
            font-size: 1em;
            color: var(--text-color);
            text-decoration: none;
        }
    </style>
    <script>
        let currentFont = 'Noto Sans Mono';
        
        function toAccentedPinyin(input) {
            const toneMap = {
                '1': 'āēīōūǖ',
                '2': 'áéíóúǘ',
                '3': 'ǎěǐǒǔǚ',
                '4': 'àèìòùǜ',
                '5': 'aeiouü'
            };
            
            function applyToneMark(syllable, tone) {
                if (!tone) return syllable;
                
                const vowels = ['a', 'e', 'i', 'o', 'u', 'ü'];
                let syllableLower = syllable.toLowerCase();
                
                if (syllableLower.includes('a')) {
                    let index = syllableLower.indexOf('a');
                    let result = syllable.split('');
                    result[index] = toneMap[tone][0];
                    return result.join('');
                }
                
                if (syllableLower.includes('e')) {
                    let index = syllableLower.indexOf('e');
                    let result = syllable.split('');
                    result[index] = toneMap[tone][1];
                    return result.join('');
                }
                
                if (syllableLower.includes('ou')) {
                    let index = syllableLower.indexOf('o');
                    let result = syllable.split('');
                    result[index] = toneMap[tone][3];
                    return result.join('');
                }
                
                for (let i = syllableLower.length - 1; i >= 0; i--) {
                    let char = syllableLower[i];
                    let vowelIndex = vowels.indexOf(char);
                    if (vowelIndex !== -1) {
                        let result = syllable.split('');
                        result[i] = toneMap[tone][vowelIndex];
                        return result.join('');
                    }
                }
                
                return syllable;
            }

            let result = input.replace(/\[([a-z]+)([1-5])?\]/gi, (match, syllable, tone) => {
                return '[' + applyToneMark(syllable, tone) + ']';
            });
            
            result = result.replace(/\b([a-z]+)([1-5])?\b/gi, (match, syllable, tone) => {
                return applyToneMark(syllable, tone);
            });
            
            return result;
        }
    </script>
</head>

{% if darkmode %}
<body class="darkmode">
{% else %}
<body>
{% endif %}
    <a href="{{ url_for('home') }}" id="backLink">&lt;&lt; home</a>
    <h1 id="title">Character Grid</h1>
    <h3 id="title_word_count"></h3>
    <div class="has-submenu" id="deckMenu">
        <span class="submenuName" id="deckSubmenuName">sets</span>
        <ul class="gridSubmenu" id="deckSubmenu">
            {% for key, deck in decknames_sorted_with_name.items() %}
                <li class="menu-option-parent"><a class="deck-option deck-change" data-deck="{{ key }}">{{ deck }}</a></li>
            {% endfor %}
        </ul>
    </div>
    <div class="has-submenu" id="fontMenu">
        <span class="submenuName" id="fontSubmenuName">fonts</span>
        <ul class="gridSubmenu" id="fontSubmenu">
            <li class="menu-option-parent"><a class="deck-option font-change" data-font="Noto Sans Mono">Noto Sans</a></li>
            <li class="menu-option-parent"><a class="deck-option font-change" data-font="Noto Serif SC">Noto Serif</a></li>
            <li class="menu-option-parent"><a class="deck-option font-change" data-font="Kaiti">Kaiti</a></li>
        </ul>
    </div>
        
        {% include 'menu.html' %}
    </div>
    <div id="grid-cont" class="grid-container">
        <div class="grid" id="character-grid"></div>
    </div>
    <div id="lcontainer">
    </div>

    {% include 'flashcard.html' %}

    <p id="message"></p>
    <div id="typedDisplay" style="display: none;"></div>
    <div id="pinyin-hover-box" style="display: none;"></div>

    <script>
        let inputdecks = {{ inputedeckdata | tojson | safe }};
        let inputdeck = {{ inputdeck | tojson | safe }};
        custom_deck_names = {{ custom_deck_names | tojson | safe }};
        let isDarkMode = {{ darkmode | tojson | safe }};
        const username = {{ username | tojson | safe }};
    </script>
    <script>

        // document.addEventListener('DOMContentLoaded', function() {
        // const characterDiv = document.getElementById('flashcard_character');
        // const plotterDiv = document.getElementById('flashcard_plotter');
        // const container = document.getElementById('flashcard_container');

        // // Initially show the character div and hide the plotter div
        // characterDiv.style.display = 'block';
        // plotterDiv.style.display = 'none';

        // container.addEventListener('click', function() {
        //     if (characterDiv.style.display === 'block') {
        //         characterDiv.style.display = 'none';
        //         plotterDiv.style.display = 'block';
        //     } else {
        //         characterDiv.style.display = 'block';
        //         plotterDiv.style.display = 'none';
        //     }
        // });
    // });
    </script>
    <!-- <script src="{{ url_for('static', filename='js/perlin.js') }}"></script> -->
    <!-- <script src="{{ url_for('static', filename='js/border.js') }}"></script> -->
    <script src="{{ url_for('static', filename='js/hamburger.js') }}" async></script>
    <script src="{{ url_for('static', filename='js/darkmode.js') }}" async></script>
    <!-- <script src="{{ url_for('static', filename='js/customback.js') }}"></script> -->
    <script src="{{ url_for('static', filename='js/flashcard.js') }}" async></script>
    <script src="{{ url_for('static', filename='js/grid.js') }}" async></script>
    <!-- <script src="{{ url_for('static', filename='js/contextmenu.js') }}"></script> -->
</body>
</html>