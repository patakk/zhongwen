const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-D9NOukqS.js","assets/_commonjsHelpers-Cpj98o6Y.js"])))=>i.map(i=>d[i]);
import{_ as R,c,o as a,a as l,b as h,w as d,n as S,d as w,t as M,e as k,v as _,f as O}from"./index-BwZ6rdTU.js";let x=null;const P={name:"OcrPanel",emits:["insert-text"],data(){return{file:null,fileName:"",previewUrl:"",isDragOver:!1,isProcessing:!1,isReady:!1,progressValue:0,statusMessage:"Loading OCR engine...",progressMessage:"",error:"",ocrText:"",copySuccess:!1,tesseract:null,hasOcrResult:!1,showCropper:!1,cropSelection:null,cropSelecting:!1,cropImageDims:{displayWidth:0,displayHeight:0,offsetX:0,offsetY:0}}},computed:{progressPercent(){if(!this.progressValue)return 0;const t=Math.round(this.progressValue*100);return Math.min(100,Math.max(0,t))},cropStyle(){if(!this.cropSelection)return{};const{x:t,y:e,w:o,h:n}=this.normalizedSelection(),{offsetX:r=0,offsetY:s=0}=this.cropImageDims||{};return{left:`${r+t}px`,top:`${s+e}px`,width:`${o}px`,height:`${n}px`}},runButtonStyle(){const t=this.progressPercent||0;return{backgroundImage:`linear-gradient(90deg, color-mix(in oklab, var(--fg) 80%, var(--bg) 15%) ${t}%, color-mix(in oklab, var(--fg) 70%, var(--bg) 25%) ${t}%)`}}},async mounted(){await this.ensureLibLoaded()},beforeUnmount(){this.previewUrl&&URL.revokeObjectURL(this.previewUrl)},methods:{handleFileChange(t){const[e]=t.target.files||[];this.setFile(e)},handleDrop(t){var o;this.isDragOver=!1;const[e]=((o=t.dataTransfer)==null?void 0:o.files)||[];this.setFile(e)},openFilePicker(){this.$refs.fileInput&&this.$refs.fileInput.click()},setFile(t){t&&(this.previewUrl&&URL.revokeObjectURL(this.previewUrl),this.file=t,this.fileName=t.name,this.previewUrl=URL.createObjectURL(t),this.error="",this.ocrText="",this.copySuccess=!1,this.progressValue=0,this.progressMessage="",this.hasOcrResult=!1,this.showCropper=!1)},openCropper(){this.previewUrl&&(this.showCropper=!0,this.$nextTick(()=>this.initCropSelection()))},closeCropper(){this.showCropper=!1,this.cropSelecting=!1},initCropSelection(){const t=this.$refs.cropImg;if(!t)return;const e=t.getBoundingClientRect(),{width:o,height:n}=e,r=this.$refs.cropStage,s=r?r.getBoundingClientRect():e;let i=0,p=0;if(r){const m=getComputedStyle(r),C=parseFloat(m.borderLeftWidth||"0"),v=parseFloat(m.borderTopWidth||"0");i=parseFloat(m.paddingLeft||"0")+C,p=parseFloat(m.paddingTop||"0")+v}const y=e.left-s.left-i,g=e.top-s.top-p;this.cropImageDims={displayWidth:o,displayHeight:n,offsetX:y,offsetY:g};const f=Math.min(o,n)*.7,u=Math.max(0,(o-f)/2),b=Math.max(0,(n-f)/2);this.cropSelection={x:u,y:b,w:f,h:f},this.$nextTick(()=>{this.cropSelection=this.normalizedSelection()})},pointerPos(t){var y,g;const e=this.$refs.cropStage;if(!e)return null;const o=e.getBoundingClientRect(),n=getComputedStyle(e),r=parseFloat(n.paddingLeft||"0")+parseFloat(n.borderLeftWidth||"0")+2,s=parseFloat(n.paddingTop||"0")+parseFloat(n.borderTopWidth||"0")+2,i=t.clientX??(t.touches&&((y=t.touches[0])==null?void 0:y.clientX)),p=t.clientY??(t.touches&&((g=t.touches[0])==null?void 0:g.clientY));return i===void 0||p===void 0?null:{x:i-o.left-r,y:p-o.top-s}},startCrop(t){const e=this.pointerPos(t);if(!e)return;const{offsetX:o=0,offsetY:n=0,displayWidth:r,displayHeight:s}=this.cropImageDims||{},i=Math.max(0,Math.min(e.x-o,r)),p=Math.max(0,Math.min(e.y-n,s));this.cropSelecting=!0,this.cropSelection={x:i,y:p,w:0,h:0}},onCropMove(t){if(!this.cropSelecting||!this.cropSelection)return;const e=this.pointerPos(t);if(!e)return;const{offsetX:o=0,offsetY:n=0,displayWidth:r,displayHeight:s}=this.cropImageDims||{},i=Math.max(0,Math.min(e.x-o,r)),p=Math.max(0,Math.min(e.y-n,s));this.cropSelection={...this.cropSelection,w:i-this.cropSelection.x,h:p-this.cropSelection.y}},endCrop(){this.cropSelecting&&(this.cropSelecting=!1,this.cropSelection=this.normalizedSelection())},clampToImage(t){const{displayWidth:e=0,displayHeight:o=0}=this.cropImageDims||{};return{x:Math.max(0,Math.min(t.x,e)),y:Math.max(0,Math.min(t.y,o))}},normalizedSelection(){if(!this.cropSelection)return null;let{x:t,y:e,w:o,h:n}=this.cropSelection;o<0&&(t+=o,o=Math.abs(o)),n<0&&(e+=n,n=Math.abs(n));const r=this.cropImageDims.displayWidth||o,s=this.cropImageDims.displayHeight||n;return t=Math.max(0,Math.min(t,r)),e=Math.max(0,Math.min(e,s)),o=Math.min(o,r-t),n=Math.min(n,s-e),{x:t,y:e,w:o,h:n}},cleanOcrText(t){return t?t.replace(/[^\p{Script=Han}\s]/gu,"").replace(/\s+/g," ").trim():""},async applyCrop(){var m;const t=this.$refs.cropImg;if(!t||!this.cropSelection)return;const e=this.normalizedSelection();if(!e||!e.w||!e.h){this.closeCropper();return}const o=t.naturalWidth||t.width,n=t.naturalHeight||t.height,r=t.getBoundingClientRect(),s=o/r.width,i=n/r.height,p=e.x*s,y=e.y*i,g=e.w*s,f=e.h*i,u=document.createElement("canvas");u.width=Math.max(1,Math.round(g)),u.height=Math.max(1,Math.round(f)),u.getContext("2d").drawImage(t,p,y,g,f,0,0,u.width,u.height),u.toBlob(C=>{if(!C){this.closeCropper();return}const v=new File([C],this.fileName||"ocr-crop.png",{type:C.type});this.setFile(v),this.closeCropper()},((m=this.file)==null?void 0:m.type)||"image/png")},async ensureLibLoaded(){if(x){this.tesseract=x,this.isReady=!0,this.statusMessage="";return}if(!this.tesseract){this.isReady=!1,this.statusMessage="Loading OCR engine...";try{const t=await O(()=>import("./index-D9NOukqS.js").then(e=>e.i),__vite__mapDeps([0,1]));if(this.tesseract=t!=null&&t.recognize?t:t.default,!this.tesseract||!this.tesseract.recognize)throw new Error("Tesseract recognize not available");x=this.tesseract,this.isReady=!0,this.statusMessage="Ready",setTimeout(()=>{this.statusMessage==="Ready"&&(this.statusMessage="")},800)}catch(t){console.error("Failed to load tesseract",t),this.error="Unable to load OCR tools. Please retry.",this.statusMessage=""}}},handleProgress(t){t&&(t.progress!==void 0&&(this.progressValue=t.progress),t.status&&(this.progressMessage=`${t.status} ${t.progress?Math.round(t.progress*100)+"%":""}`.trim()))},async runOcr(){if(!this.file){this.error="Choose an image to start.";return}if(await this.ensureLibLoaded(),!!this.tesseract){this.isProcessing=!0,this.error="",this.ocrText="",this.copySuccess=!1,this.progressValue=0,this.progressMessage="Preparing...",this.hasOcrResult=!1;try{const{data:t}=await this.tesseract.recognize(this.file,"chi_sim",{logger:o=>this.handleProgress(o)}),e=((t==null?void 0:t.text)||"").trim();this.ocrText=this.cleanOcrText(e),this.progressValue=1,this.progressMessage="Done",this.hasOcrResult=!0}catch(t){console.error("OCR failed",t),this.error="OCR failed. Please try a clearer image or retry."}finally{this.isProcessing=!1}}},async copyResult(){if(!(!this.ocrText||!(navigator!=null&&navigator.clipboard)))try{await navigator.clipboard.writeText(this.ocrText),this.copySuccess=!0,setTimeout(()=>{this.copySuccess=!1},1500)}catch(t){console.error("Copy failed",t)}},emitToSearch(){this.ocrText&&this.$emit("insert-text",this.ocrText.trim())}}},T={class:"ocr-panel-container"},D={class:"ocr-panel"},F={class:"input-row"},L={class:"drop-area-wrapper"},I={key:0,class:"drop-copy"},U={key:0,class:"drop-title"},z={key:1,class:"drop-hint"},W={key:1,class:"preview"},X=["src"],Y={key:2,class:"drop-actions"},B=["disabled"],V={key:0},H={key:1},N={key:2},E={key:0,class:"result result-wrapper"},j={class:"result-header"},A={class:"result-actions"},G=["disabled"],J={class:"result-body"},q={key:0,class:"error"},K={key:0,class:"crop-modal"},Q={class:"crop-dialog"},Z={class:"crop-header"},$=["src"],ee={class:"crop-actions"},te=["disabled"];function se(t,e,o,n,r,s){return a(),c("div",T,[l("div",D,[l("div",F,[l("div",L,[l("div",{class:S(["drop-area",{"is-active":r.isDragOver}]),onDragover:e[3]||(e[3]=d(i=>r.isDragOver=!0,["prevent"])),onDragleave:e[4]||(e[4]=d(i=>r.isDragOver=!1,["prevent"])),onDrop:e[5]||(e[5]=d((...i)=>s.handleDrop&&s.handleDrop(...i),["prevent"])),onClick:e[6]||(e[6]=(...i)=>s.openFilePicker&&s.openFilePicker(...i))},[l("input",{ref:"fileInput",type:"file",accept:"image/*",class:"file-input",onChange:e[0]||(e[0]=(...i)=>s.handleFileChange&&s.handleFileChange(...i))},null,544),r.file?h("",!0):(a(),c("div",I,[r.file?h("",!0):(a(),c("div",U,"Drop an image or click to choose")),r.file?h("",!0):(a(),c("div",z,"PNG, JPG, screenshots. Nothing is uploaded to our servers."))])),r.previewUrl?(a(),c("div",W,[l("img",{src:r.previewUrl,alt:"Selected for OCR"},null,8,X)])):h("",!0),r.file?(a(),c("div",Y,[l("button",{type:"button",class:"crop-btn",onClick:e[1]||(e[1]=d((...i)=>s.openCropper&&s.openCropper(...i),["stop"]))}," Crop image "),l("button",{type:"button",class:S(["btn-primary run-btn",{processing:r.isProcessing}]),onClick:e[2]||(e[2]=d((...i)=>s.runOcr&&s.runOcr(...i),["stop"])),disabled:!r.file||r.isProcessing||!r.isReady,style:w(s.runButtonStyle)},[r.isProcessing?(a(),c("span",V,"Running OCR...")):r.isReady?(a(),c("span",N,"Run OCR")):(a(),c("span",H,"Preparing OCR..."))],14,B)])):h("",!0)],34)]),r.hasOcrResult||r.ocrText?(a(),c("div",E,[l("div",j,[l("div",A,[l("button",{type:"button",class:"chip",onClick:e[7]||(e[7]=(...i)=>s.copyResult&&s.copyResult(...i)),disabled:r.copySuccess},M(r.copySuccess?"Copied":"Copy"),9,G),l("button",{type:"button",class:"chip primary",onClick:e[8]||(e[8]=(...i)=>s.emitToSearch&&s.emitToSearch(...i))}," Add to search ")])]),l("div",J,[k(l("textarea",{"onUpdate:modelValue":e[9]||(e[9]=i=>r.ocrText=i),style:{"box-sizing":"border-box"}},null,512),[[_,r.ocrText]])])])):h("",!0)]),r.error?(a(),c("div",q,M(r.error),1)):h("",!0)]),r.showCropper?(a(),c("div",K,[l("div",Q,[l("div",Z,[e[18]||(e[18]=l("div",null,[l("div",{class:"crop-title"},"Crop image"),l("div",{class:"crop-subtitle"},"Drag to select the area to OCR.")],-1)),l("button",{type:"button",class:"chip",onClick:e[10]||(e[10]=(...i)=>s.closeCropper&&s.closeCropper(...i))},"Cancel")]),l("div",{class:"crop-stage",ref:"cropStage",onPointerdown:e[12]||(e[12]=d((...i)=>s.startCrop&&s.startCrop(...i),["prevent"])),onPointermove:e[13]||(e[13]=d((...i)=>s.onCropMove&&s.onCropMove(...i),["prevent"])),onPointerup:e[14]||(e[14]=d((...i)=>s.endCrop&&s.endCrop(...i),["prevent"])),onPointerleave:e[15]||(e[15]=d((...i)=>s.endCrop&&s.endCrop(...i),["prevent"]))},[l("img",{ref:"cropImg",src:r.previewUrl,alt:"Crop",onLoad:e[11]||(e[11]=(...i)=>s.initCropSelection&&s.initCropSelection(...i))},null,40,$),r.cropSelection?(a(),c("div",{key:0,class:"crop-rect",style:w(s.cropStyle)},null,4)):h("",!0)],544),l("div",ee,[l("button",{type:"button",class:"btn-secondary",onClick:e[16]||(e[16]=(...i)=>s.closeCropper&&s.closeCropper(...i))},"Back"),l("button",{type:"button",class:"btn-primary",onClick:e[17]||(e[17]=(...i)=>s.applyCrop&&s.applyCrop(...i)),disabled:!r.cropSelection||r.isProcessing}," Apply crop ",8,te)])])])):h("",!0)])}const ie=R(P,[["render",se],["__scopeId","data-v-ea7f496e"]]);export{ie as default};
