import{_ as q,d as B,c as N,a as Q,o as W,b as Y,r as F,e as U,f as X,g as R,w as C,n as j}from"./index-Wkx7j4vH.js";const z=4,M=1<<z,_=8,$=1<<_,b=4095;let G=4,J=.5;const L=e=>.5*(1-Math.cos(e*Math.PI));let A;function O(){let e=!1;return function(a){(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4)))&&(e=!0)}(navigator.userAgent||navigator.vendor||window.opera),e||/iPad|iPhone|iPod/.test(navigator.platform)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1}var E=function(e,a=0,n=0){if(A==null){A=new Array(b+1);for(let g=0;g<b+1;g++)A[g]=Math.random()}e<0&&(e=-e),a<0&&(a=-a),n<0&&(n=-n);let s=Math.floor(e),t=Math.floor(a),i=Math.floor(n),r=e-s,o=a-t,l=n-i,c,h,u=0,m=.5,f,v,p;for(let g=0;g<G;g++){let d=s+(t<<z)+(i<<_);c=L(r),h=L(o),f=A[d&b],f+=c*(A[d+1&b]-f),v=A[d+M&b],v+=c*(A[d+M+1&b]-v),f+=h*(v-f),d+=$,v=A[d&b],v+=c*(A[d+1&b]-v),p=A[d+M&b],p+=c*(A[d+M+1&b]-p),v+=h*(p-v),f+=L(l)*(v-f),u+=f*m,m*=J,s<<=1,r*=2,t<<=1,o*=2,i<<=1,l*=2,r>=1&&(s++,r--),o>=1&&(t++,o--),l>=1&&(i++,l--)}return u};function V(e,a,n,s,t,i,r){!a&&!n||(e.save(),e.lineWidth=Math.max(.6,e.canvas.width/128)*.6*r,e.strokeStyle=i[1],e.strokeStyle="rgba(111,111,111, .215)",a&&(e.save(),e.lineCap=s,e.lineJoin=s,e.strokeStyle=i[1],e.beginPath(),e.moveTo(0,0),e.lineTo(e.canvas.width,e.canvas.height),e.stroke(),e.beginPath(),e.moveTo(e.canvas.width,0),e.lineTo(0,e.canvas.height),e.stroke(),e.beginPath(),e.moveTo(e.canvas.width/2,0),e.lineTo(e.canvas.width/2,e.canvas.height),e.stroke(),e.beginPath(),e.moveTo(0,e.canvas.height/2),e.lineTo(e.canvas.width,e.canvas.height/2),e.stroke(),e.restore()),n&&(e.strokeStyle="rgba(111,111,111, .215)",e.beginPath(),e.lineCap=s,e.moveTo(e.canvas.width/3,0),e.lineTo(e.canvas.width/3,e.canvas.height),e.stroke(),e.beginPath(),e.moveTo(e.canvas.width*2/3,0),e.lineTo(e.canvas.width*2/3,e.canvas.height),e.stroke(),e.beginPath(),e.moveTo(0,e.canvas.height/3),e.lineTo(e.canvas.width,e.canvas.height/3),e.stroke(),e.beginPath(),e.moveTo(0,e.canvas.height*2/3),e.lineTo(e.canvas.width,e.canvas.height*2/3),e.stroke()),e.restore())}function Z(e,a=.5){let n=[e[0]];for(let s=1;s<e.length-1;s++){let t=e[s-1],i=e[s],r=e[s+1],o={x:i.x+a*(t.x+r.x-2*i.x),y:i.y+a*(t.y+r.y-2*i.y)};n.push(o)}return n.push(e[e.length-1]),n}function H(e,a=2){let n=[];for(let s=0;s<e.length-1;s++){let t=e[s],i=e[s+1];n.push(t);for(let r=1;r<=a;r++){let o=r/(a+1),l=t.x+o*(i.x-t.x),c=t.y+o*(i.y-t.y);n.push({x:l,y:c})}}return n.push(e[e.length-1]),n}function K(e){return e.map(n=>(n=it(n,30),n=H(n,4),n=Z(n,.5),n))}function tt(e){let a=0,n=[];for(let s=0;s<e.length-1;s++){let t=e[s],i=e[s+1],r=i.x-t.x,o=i.y-t.y,l=Math.sqrt(r*r+o*o);a+=l,n.push(l)}return{totalLength:a,segmentLengths:n}}function et(e,a){let n=tt(e),s=n.totalLength,t=n.segmentLengths,i=s*a,r=0;for(let o=0;o<t.length;o++)if(r+=t[o],r>=i){let l=e[o],c=e[o+1],u=(i-(r-t[o]))/t[o];return{x:l.x+u*(c.x-l.x),y:l.y+u*(c.y-l.y)}}return e[e.length-1]}function st(e,a){let n=[];for(let s=0;s<a;s++){let t=s/(a-1),i=et(e,t);n.push(i)}return n}function it(e,a=5){if(e.length<3)return e;let n=[e[0]];for(let s=1;s<e.length-1;s++){let t=n[n.length-1],i=e[s],r=e[s+1],o=Math.hypot(i.x-t.x,i.y-t.y),l=Math.hypot(r.x-i.x,r.y-i.y);(o>=a||l>=a)&&n.push(i)}return n.push(e[e.length-1]),n}function P(e,a,n=0,s=0,t=800){a=a.replace(/([A-Za-z])/g," $1 ").replace(/\s+/g," ").trim();const i=a.split(" ");let r=0,o=0,l=0,c=0,h=0;for(;h<i.length;){const u=i[h++];if(u)switch(u.toUpperCase()){case"M":for(l=r=parseFloat(i[h++]),c=o=parseFloat(i[h++]),r=r/1e3*t+n*t/1e3,o=t-o/1e3*t+s*t/1e3,e.moveTo(r,o);h<i.length&&!isNaN(parseFloat(i[h]));)r=parseFloat(i[h++]),o=parseFloat(i[h++]),r=r/1e3*t+n*t/1e3,o=t-o/1e3*t+s*t/1e3,e.lineTo(r,o);break;case"L":for(;h<i.length&&!isNaN(parseFloat(i[h]));)r=parseFloat(i[h++]),o=parseFloat(i[h++]),r=r/1e3*t+n*t/1e3,o=t-o/1e3*t+s*t/1e3,e.lineTo(r,o);break;case"Q":for(;h+3<i.length&&!isNaN(parseFloat(i[h]));){const m=parseFloat(i[h++]),f=parseFloat(i[h++]);r=parseFloat(i[h++]),o=parseFloat(i[h++]);const v=m/1e3*t+n*t/1e3,p=t-f/1e3*t+s*t/1e3,g=r/1e3*t+n*t/1e3,d=t-o/1e3*t+s*t/1e3;e.quadraticCurveTo(v,p,g,d)}break;case"C":for(;h+5<i.length&&!isNaN(parseFloat(i[h]));){const m=parseFloat(i[h++]),f=parseFloat(i[h++]),v=parseFloat(i[h++]),p=parseFloat(i[h++]);r=parseFloat(i[h++]),o=parseFloat(i[h++]);const g=m/1e3*t+n*t/1e3,d=t-f/1e3*t+s*t/1e3,y=v/1e3*t+n*t/1e3,x=t-p/1e3*t+s*t/1e3,k=r/1e3*t+n*t/1e3,w=t-o/1e3*t+s*t/1e3;e.bezierCurveTo(g,d,y,x,k,w)}break;case"Z":e.closePath(),r=l,o=c;break;default:console.warn(`Unrecognized SVG path command: ${u}`);break}}}const at="idle";class nt{constructor({character:a,strokes:n,masks:s,dimension:t=100,speed:i=1,lineThickness:r=2,gridThickness:o=1,jitterAmp:l=0,colors:c=["#0f0"],lineType:h="round",showDiagonals:u=!1,showGrid:m=!1,state:f=at,clickAnimation:v=!0,clearBackground:p=!0,useMask:g=!1,canvas:d=null,blendMode:y="normal",dontLoadIfMissing:x=!1}){this.character=a,this.strokes_=n,this.masks_=s,this.dimension=t,this.speed=i,this.seed=Math.random()*1e3,this.lineThickness=r,this.gridThickness=o,this.jitterAmp=l,this.colors=c,this.lineType=h,this.clickAnimation=v,this.dontLoadIfMissing=x,this.strokeAttempts=0,this.state=f,this.clearBackground=!0,this.loadPromise=null,this.blendMode=y,this.demoMode=!1,this.useMask=g,this.userStrokes=[],this.currentStroke=null,this.isDrawing=!1,this.quizComplete=!1,this.isQuizing=!1,this.isDestroyed=!1,this.mouseDownWhileQuizing=!1,this.showDiagonals=u,this.showGrid=m,this.clickListener=null,this.lastX=null,this.lastY=null,this.easingFactor=.4,d?(this.canvas=d,this.canvas.width=this.dimension,this.canvas.height=this.dimension,this.ctx=this.canvas.getContext("2d")):(this.canvas=document.createElement("canvas"),this.canvas.width=this.dimension,this.canvas.height=this.dimension,this.ctx=this.canvas.getContext("2d")),this.init()}replaceStrokes(a,n,s){this.character=a,this.strokes_=n,this.masks_=s,this.totalLength=null,this.init()}init(){this.originalStrokes=void 0,this.strokes_?(this.processStrokes(this.strokes_),this.processMasks(this.masks_),this.setupDrawingEvents(),this.isAnimating=!1,this.isAnimatingStroke=!1,this.isAnimatingInterp=!1,this.animationProgress=0,this.animationFrame=null,this.loadPromise=Promise.resolve()):this.dontLoadIfMissing?this.loadPromise=Promise.resolve():this.loadPromise=this.loadStrokeData(this.onDataReady.bind(this))}processMasks(a){this.masks_=a}onDataReady(){this.data===void 0||this.data===null||(this.processStrokes(this.data.medians),this.processMasks(this.data.strokes),this.setupDrawingEvents(),this.isAnimating=!1,this.isAnimatingStroke=!1,this.isAnimatingInterp=!1,this.animationProgress=0,this.animationFrame=null,this.clickAnimation&&(O()?this.clickListener=this.canvas.addEventListener("touchstart",this.startAnimation.bind(this)):this.clickListener=this.canvas.addEventListener("click",this.startAnimation.bind(this))))}destroyy(){this.isDestroyed=!0,this.animationFrame&&(cancelAnimationFrame(this.animationFrame),this.animationFrame=null),this.strokeAnimationFrame&&(cancelAnimationFrame(this.strokeAnimationFrame),this.strokeAnimationFrame=null),this.interpAnimFrame&&(cancelAnimationFrame(this.interpAnimFrame),this.interpAnimFrame=null),this.demoAnimationFrame&&(cancelAnimationFrame(this.demoAnimationFrame),this.demoAnimationFrame=null),this.canvas&&(this.canvas.removeEventListener("mousedown",this.startUserDrawing),this.canvas.removeEventListener("mousemove",this.userStrokeMove),this.canvas.removeEventListener("mouseup",this.userStrokeEnded),this.canvas.removeEventListener("mouseout",this.userStrokeEnded),this.canvas.removeEventListener("touchstart",this.handleTouchStart),this.canvas.removeEventListener("touchmove",this.handleTouchMove),this.canvas.removeEventListener("touchend",this.handleTouchEnd),this.clickListener&&this.canvas.removeEventListener("click",this.clickListener)),this.canvas=null,this.ctx=null}setupDrawingEvents(){this.canvas.addEventListener("mousedown",this.startUserDrawing.bind(this)),this.canvas.addEventListener("mousemove",this.userStrokeMove.bind(this)),this.canvas.addEventListener("mouseup",this.userStrokeEnded.bind(this)),this.canvas.addEventListener("mouseout",this.userStrokeEnded.bind(this)),this.canvas.addEventListener("touchstart",this.handleTouchStart.bind(this),{passive:!1}),this.canvas.addEventListener("touchmove",this.handleTouchMove.bind(this),{passive:!1}),this.canvas.addEventListener("touchend",this.handleTouchEnd.bind(this),{passive:!1})}handleTouchStart(a){a.preventDefault();const n=a.touches[0],s=new MouseEvent("mousedown",{clientX:n.clientX,clientY:n.clientY});this.canvas.dispatchEvent(s)}handleTouchMove(a){a.preventDefault();const n=a.touches[0],s=new MouseEvent("mousemove",{clientX:n.clientX,clientY:n.clientY});this.canvas.dispatchEvent(s)}handleTouchEnd(a){a.preventDefault();const n=new MouseEvent("mouseup",{});this.canvas.dispatchEvent(n)}startUserDrawing(a){if(!this.isQuizing||this.isAnimatingStroke||this.isAnimatingInterp)return;this.mouseDownWhileQuizing=!0,this.isDrawing=!0,this.currentStroke=[];const n=this.canvas.getBoundingClientRect(),s=(a.clientX-n.left)*(this.canvas.width/n.width),t=(a.clientY-n.top)*(this.canvas.height/n.height);this.lastX=s,this.lastY=t,this.currentStroke.push({x:s,y:t}),this.drawUserStrokes()}userStrokeMove(a){if(!this.isDrawing||!this.isQuizing)return;const n=this.canvas.getBoundingClientRect(),s=(a.clientX-n.left)*(this.canvas.width/n.width),t=(a.clientY-n.top)*(this.canvas.height/n.height),i=this.lastX+(s-this.lastX)*this.easingFactor,r=this.lastY+(t-this.lastY)*this.easingFactor;this.lastX=i,this.lastY=r,this.currentStroke.push({x:i,y:r}),this.drawUserStrokes()}compareToReal(a,n){const s=n.map(y=>({x:y.x/1e3,y:y.y/1e3})),t=a.map(y=>({x:y.x/this.dimension,y:y.y/this.dimension})),i={x:s[s.length-1].x-s[0].x,y:s[s.length-1].y-s[0].y},r={x:t[t.length-1].x-t[0].x,y:t[t.length-1].y-t[0].y},o=y=>{const x=Math.hypot(y.x,y.y);return{x:y.x/x,y:y.y/x}},l=o(i),c=o(r),h=l.x*c.x+l.y*c.y,u=Math.hypot(t[0].x-s[0].x,t[0].y-s[0].y),m=.35,f=Math.hypot(i.x,i.y),v=Math.hypot(r.x,r.y),p=.5,g=Math.abs(v-f)/f,d=.8;return f<.16?h>d&&u<m:h>d&&u<m&&g<p}startStrokeAnimation(){if(!this.isQuizing)return;this.isAnimatingStroke=!0,this.strokeStartTime=Date.now();const n=this.strokes[this.userStrokes.length].length/this.speed*1,s=()=>{const t=Date.now()-this.strokeStartTime,i=Math.min(t/n,1);this.clearBg(),this.drawUserStrokes(),this.ctx.save(),this.ctx.lineCap=this.lineType,this.ctx.lineJoin=this.lineType,this.ctx.strokeStyle=this.colors[0],this.ctx.lineWidth=this.lineThickness*1.24,this.drawStroke(this.strokes[this.userStrokes.length],i),this.ctx.restore(),i<1?this.strokeAnimationFrame=requestAnimationFrame(s):(cancelAnimationFrame(this.strokeAnimationFrame),this.clearBg(),this.isAnimatingStroke=!1,this.drawUserStrokes(!1))};this.clearBg(),this.strokeAnimationFrame=requestAnimationFrame(s)}restartQuiz(){this.userStrokes=[],this.currentStroke=null,this.strokeAttempts=0,this.quizComplete=!1,this.quiz({onComplete:this.onCompleteQuiz})}userStrokeEnded(){if(!(!this.isDrawing||!this.isQuizing)&&!(this.userStrokes.length>=this.strokes.length)){if(this.isDrawing=!1,this.currentStroke&&this.currentStroke.length>0){if(this.compareToReal(this.currentStroke,this.strokes[this.userStrokes.length])){st(this.currentStroke,this.strokes[this.userStrokes.length].length);const n=this.strokes[this.userStrokes.length].map(s=>({x:s.x/1e3*this.dimension,y:s.y/1e3*this.dimension}));this.userStrokes.push(n),this.strokeAttempts=0}else this.strokeAttempts<2?this.strokeAttempts++:(this.strokeAttempts++,this.startStrokeAnimation(),this.isAnimatingStroke=!0);this.userStrokes.length===this.strokes.length&&(this.quizComplete=!0,this.clearBg(),this.demoMode=!1,cancelAnimationFrame(this.demoAnimationFrame),this.startInterpol(),this.onCompleteQuiz({strokes:this.userStrokes,character:this.character})),this.currentStroke=null}this.quizComplete||this.drawUserStrokes()}}helpMode(){if(this.quizComplete)return;this.demoMode=!0;let a=.5;const n=()=>{this.clearBg(a),a-=.004,a>0&&(this.demoAnimationFrame=requestAnimationFrame(n))};this.demoAnimationFrame=requestAnimationFrame(n)}startInterpol(){this.isAnimatingInterp=!0;let a=this.userStrokes,n=0,s=0;const t=()=>{s++,n=.5+Math.cos(s/50*Math.PI)*.5;let i=this.strokes.map((o,l)=>o.map((h,u)=>{let m=a[l][u];return{x:m.x*n*1e3/this.dimension+h.x*(1-n),y:m.y*n*1e3/this.dimension+h.y*(1-n)}})),r=i.reduce((o,l)=>o+this.getStrokeLength(l),0);this.draw({progress:1,clearbg:!0,onDrawComplete:null,alpha:1,strokes_in:i,strokes_in_length:r}),this.interpAnimFrame=requestAnimationFrame(t),s==50&&(cancelAnimationFrame(this.interpAnimFrame),this.clearBg(),this.isAnimatingInterp=!1),s==40&&(this.isQuizing=!1)};t()}drawUserStrokes(a=!0,n=!1){if(this.isQuizing){if(a&&this.clearBg(),this.ctx.save(),this.ctx.strokeStyle=this.colors[2],this.ctx.lineWidth=this.lineThickness,this.ctx.lineCap=this.lineType,n){this.ctx.save(),this.ctx.lineCap=this.lineType,this.ctx.lineJoin=this.lineType,this.ctx.strokeStyle=this.colors[0],this.ctx.lineWidth=this.useMask?this.lineThickness*6:this.lineThickness*1;for(let s=0;s<this.userStrokes.length;s++){const t=this.strokes[s];if(!(t.length<2)){if(this.useMask&&this.masks_&&s<this.masks_.length){this.ctx.save();let i=new Path2D;P(i,this.masks_[s],this.offsetX,this.offsetY,this.dimension),this.ctx.clip(i)}this.ctx.beginPath(),this.ctx.moveTo(t[0].x/1e3*this.dimension,t[0].y/1e3*this.dimension);for(let i=1;i<t.length;i++)this.ctx.lineTo(t[i].x/1e3*this.dimension,t[i].y/1e3*this.dimension);this.ctx.stroke(),this.useMask&&this.masks_&&s<this.masks_.length&&this.ctx.restore()}}this.ctx.restore()}else{this.ctx.save(),this.ctx.strokeStyle=this.colors[0],this.ctx.lineWidth=this.lineThickness*.5,this.ctx.lineWidth=this.lineThickness*1.24,this.ctx.lineWidth=this.useMask?this.lineThickness*6:this.lineThickness*1;for(let s=0;s<this.userStrokes.length;s++){const t=this.userStrokes[s];if(!(t.length<2)){if(this.useMask&&this.masks_&&s<this.masks_.length){this.ctx.save();let i=new Path2D;P(i,this.masks_[s],this.offsetX,this.offsetY,this.dimension),this.ctx.clip(i)}this.ctx.beginPath(),this.ctx.moveTo(t[0].x,t[0].y);for(let i=1;i<t.length;i++)this.ctx.lineTo(t[i].x,t[i].y);this.ctx.stroke(),this.useMask&&this.masks_&&s<this.masks_.length&&this.ctx.restore()}}this.ctx.restore()}if(this.currentStroke&&this.currentStroke.length>1&&this.quizComplete===!1){this.ctx.save(),this.ctx.lineCap=this.lineType,this.ctx.lineJoin=this.lineType,this.ctx.strokeStyle=this.colors[2],this.ctx.lineWidth=this.lineThickness*1,this.ctx.lineWidth=this.lineThickness*1,this.ctx.beginPath(),this.ctx.moveTo(this.currentStroke[0].x,this.currentStroke[0].y);for(let s=1;s<this.currentStroke.length;s++)this.ctx.lineTo(this.currentStroke[s].x,this.currentStroke[s].y);this.ctx.stroke(),this.ctx.restore()}this.ctx.restore()}}async quiz(a){this.onCompleteQuiz=a.onComplete,await this.loadPromise,this.userStrokes=[],this.currentStroke=null,this.isQuizing=!0,this.clearBg()}processStrokes(a){a.map(l=>{l.map(c=>{c.x=c[0],c.y=1e3-c[1]})});let n=1/0,s=1/0,t=-1/0,i=-1/0;a.forEach(l=>{l.forEach(c=>{n=Math.min(n,c.x),s=Math.min(s,c.y),t=Math.max(t,c.x),i=Math.max(i,c.y)})});const r=0,o=(1e3-(i-s))/2-s;a=a.map(l=>l.map(c=>({x:c.x+r,y:c.y+o}))),this.strokes=K(a),this.originalStrokes=this.strokes,this.offsetX=r,this.offsetY=o}applyJitter(a,n){return a.map(s=>{let t=.001;return s.map((i,r)=>{let o=.1+Math.pow(r/s.length,1),l=o*n*(2*E(t*i.x,t*i.y,this.seed+821.31)-1),c=o*n*(2*E(t*i.x,t*i.y,this.seed+912.31)-1);return{x:i.x+l,y:i.y+c}})})}setSpeed(a){this.speed=a}setColors(a){this.colors=a}setGridThickness(a){this.gridThickness=a}displayGrid(){this.showGrid=!0}displayDiagonals(){this.showDiagonals=!0}hideGrid(){this.showGrid=!1}hideDiagonals(){this.showDiagonals=!1}setLineThickness(a){this.lineThickness=a}async setJitterAmp(a){await this.loadPromise,this.jitterAmp=a,this.jitteredStrokes=this.applyJitter(this.originalStrokes,this.jitterAmp)}getCanvas(){return this.canvas}isState(a){return this.state===a}clear(){this.ctx.clearRect(0,0,this.dimension,this.dimension)}clearBg(a=0){this.clear(),this.clearBackground||(this.ctx.fillStyle=this.colors[3],this.ctx.fillRect(0,0,this.dimension,this.dimension)),V(this.ctx,this.showDiagonals,this.showGrid,this.lineType,this.dimension,this.colors,this.gridThickness),this.demoMode&&!this.isAnimatingInterp&&(this.draw({progress:1,clearbg:!1,onDrawComplete:null,alpha:a,strokes_in:null,strokes_in_length:null}),this.drawUserStrokes(!1))}giveUp(){this.isQuizing=!1,this.clearBg(),this.startAnimation()}async startAnimation(){var r;await this.loadPromise,this.isAnimating=!0;const a=Math.random().toString(36).substring(2);this.currentAnimationId=a;let n=(r=this.originalStrokes)==null?void 0:r.map(o=>o.map(({x:l,y:c})=>({x:l,y:c}))),s=this.applyJitter(n,this.jitterAmp);this.ctx.save(),this.ctx.lineCap=this.lineType,this.ctx.lineJoin=this.lineType,this.ctx.globalCompositeOperation=this.blendMode,this.ctx.strokeStyle=this.colors[0],this.ctx.lineWidth=this.useMask?this.lineThickness*6:this.lineThickness*1.24,this.clearBg();const t=this.originalStrokes.length;this.totalStrokes=t;const i=o=>new Promise(l=>{if(typeof this.onStrokeProgress=="function")try{this.onStrokeProgress(o+1,t)}catch{}let c=null,h=10*s[o].length;const u=m=>{if(this.currentAnimationId!==a||!this.isAnimating){l("interrupted");return}c||(c=m);const f=m-c;let v=Math.min(f/h,1);this.clearBg(),this.draw({progress:1,clearbg:!1,alpha:.35}),this.drawPartial(s,o,v,1),v<1?this.animationFrame=requestAnimationFrame(u):l("completed")};this.animationFrame=requestAnimationFrame(u)});for(let o=0;o<t&&!(this.currentAnimationId!==a||!this.isAnimating||await i(o)==="interrupted");o++)if(o<t-1){const c=Date.now(),h=160;for(;Date.now()-c<h&&!(this.currentAnimationId!==a||!this.isAnimating);)await new Promise(u=>setTimeout(u,10));if(this.currentAnimationId!==a||!this.isAnimating)break}this.currentAnimationId===a&&this.stopAnimation(),this.ctx.restore()}stopAnimation(){if(this.isAnimating=!1,this.isAnimatingStroke=!1,this.isAnimatingInterp=!1,this.animationFrame&&(cancelAnimationFrame(this.animationFrame),this.animationFrame=null),this.strokeAnimationFrame&&(cancelAnimationFrame(this.strokeAnimationFrame),this.strokeAnimationFrame=null),this.interpAnimFrame&&(cancelAnimationFrame(this.interpAnimFrame),this.interpAnimFrame=null),this.demoAnimationFrame&&(cancelAnimationFrame(this.demoAnimationFrame),this.demoAnimationFrame=null),this.strokeStartTime=null,this.startTime=null,typeof this.onStrokeProgress=="function")try{this.onStrokeProgress(0,this.totalStrokes||0)}catch{}if(typeof this.onStrokeProgress=="function")try{this.onStrokeProgress(0,this.totalStrokes||0)}catch{}this.currentAnimationId=null,this.demoMode=!1,this.seed=Math.random()*1e3}async draw(a={}){var p;const{progress:n=1,clearbg:s=!0,onDrawComplete:t=null,alpha:i=1,strokes_in:r=null,strokes_in_length:o=null}=a;await this.loadPromise;let l=r||((p=this.originalStrokes)==null?void 0:p.map(g=>g.map(({x:d,y})=>({x:d,y}))));if(!l){let g=document.createElement("span");g.textContent=this.character,Object.assign(g.style,{fontSize:"10em",fontFamily:"Kaiti",margin:"0em",display:"inline-block"}),this.canvas=g;return}s&&this.clearBg(),this.totalLength=l.reduce((g,d)=>g+this.getStrokeLength(d),0);let c=l.reduce((g,d)=>g+this.getStrokeLength(d),0);o&&(c=o);let h=c*n,u=0,m=0,f=0;for(let g=0;g<l.length;g++){const d=this.getStrokeLength(l[g]);if(u+d>h){m=g,f=(h-u)/d;break}u+=d,m=g,f=1}let v=this.applyJitter(l,this.jitterAmp);this.ctx.save(),this.ctx.lineCap=this.lineType,this.ctx.lineJoin=this.lineType,this.ctx.globalAlpha=i,this.ctx.globalCompositeOperation=this.blendMode,this.colors[0]&&(this.ctx.strokeStyle=this.colors[0],this.ctx.lineWidth=this.lineThickness*1.24,this.useMask&&(this.ctx.lineWidth=this.lineThickness*5),this.drawPartial(v,m,f,i)),this.ctx.restore(),t&&t()}getStrokeLength(a){let n=0;for(let s=1;s<a.length;s++){const t=a[s].x-a[s-1].x,i=a[s].y-a[s-1].y;n+=Math.sqrt(t*t+i*i)}return n}drawPartial(a,n,s,t=1){let i;this.useMask&&(i=new Path2D);for(let r=0;r<n&&r<a.length;r++)this.useMask&&(this.ctx.save(),i=new Path2D,P(i,this.masks_[r],this.offsetX,this.offsetY,this.dimension),this.ctx.clip(i)),this.drawStroke(a[r],1,!1,t),this.useMask&&this.ctx.restore();if(n>=0&&n<a.length){if(this.useMask){this.ctx.save();let r=new Path2D;P(r,this.masks_[n],this.offsetX,this.offsetY,this.dimension),this.ctx.clip(r)}this.drawStroke(a[n],s,!1,t),this.useMask&&this.ctx.restore()}}drawStroke(a,n=1,s=!1,t=1){if(!a||a.length<2)return;n=Math.min(1,Math.max(0,n)),this.ctx.beginPath();const i=a.map(h=>({x:h.x*this.dimension/1e3,y:h.y*this.dimension/1e3}));let r=0,o=[0];for(let h=1;h<i.length;h++){const u=i[h].x-i[h-1].x,m=i[h].y-i[h-1].y;r+=Math.sqrt(u*u+m*m),o.push(r)}const l=n*r;this.ctx.moveTo(i[0].x,i[0].y);let c=0;for(let h=1;h<i.length;h++){const u=i[h-1],m=i[h],f=o[h]-o[h-1];if(c+=f,c>=l){const p=(l-(c-f))/f,g=u.x+(m.x-u.x)*p,d=u.y+(m.y-u.y)*p;if(s){const y=h>1?i[h-2]:u,x=h<i.length-1?i[h+1]:m,k=u.x+(m.x-y.x)/6,w=u.y+(m.y-y.y)/6,S=m.x-(x.x-u.x)/6,T=m.y-(x.y-u.y)/6;this.ctx.bezierCurveTo(k,w,S,T,g,d)}else this.ctx.lineTo(g,d);break}else if(s){const v=h>1?i[h-2]:u,p=h<i.length-1?i[h+1]:m,g=u.x+(m.x-v.x)/6,d=u.y+(m.y-v.y)/6,y=m.x-(p.x-u.x)/6,x=m.y-(p.y-u.y)/6;this.ctx.bezierCurveTo(g,d,y,x,m.x,m.y)}else this.ctx.lineTo(m.x,m.y)}this.ctx.stroke()}async loadStrokeData(a=null){try{this.originalStrokes=void 0;const n=await fetch(`/api/getStrokes?character=${this.character}`);if(!n.ok)return;const s=await n.json();this.data=s,a&&a()}catch(n){throw console.error("Error loading character data:",n),n}}}const rt=B({name:"AnimatedHanzi",emits:["step-change"],props:{character:{type:String,required:!0},strokes:{type:Object,default:()=>({})},animatable:{type:Boolean,default:!0},drawThin:{type:Boolean,default:!1},animSpeed:{type:Number,default:.07}},setup(e,{expose:a,emit:n}){const s=F(null),t=F(null),i=F(null),r=F(document.documentElement.getAttribute("data-theme")||"light"),o=F(!1),l=F(0),c=U(()=>e.strokes&&e.strokes.medians&&e.strokes.strokes&&Array.isArray(e.strokes.medians)&&e.strokes.medians.length>0&&Array.isArray(e.strokes.strokes)&&e.strokes.strokes.length>0),h=(k=null)=>{const w=t.value&&t.value.strokes&&t.value.strokes.length||0,S=k&&k.current!==void 0?k.current:l.value,T=!w||S<=0?0:Math.min(S,w);n("step-change",{current:T,total:w})},u=()=>{if(!t.value)return;t.value.clearBg();const k=t.value.strokes&&t.value.strokes.length||0;if(!k||l.value<=0||Math.min(l.value,k),h(),!k||l.value<=0)return;const w=Math.min(l.value-1,k-1),S=t.value.ctx;S.save(),S.lineCap=t.value.lineType,S.lineJoin=t.value.lineType,S.globalCompositeOperation=t.value.blendMode,S.strokeStyle=t.value.colors[0],S.lineWidth=t.value.useMask?t.value.lineThickness*6:t.value.lineThickness*1.24,t.value.draw({progress:1,clearbg:!1,alpha:.35}),t.value.drawPartial(t.value.strokes,w,1),S.restore()},m=()=>{let k=localStorage.getItem("theme")||"light",w;return k==="dark"&&(w=["#e5ddeddd","#e2cdec88","#e5dded","#151515"]),k==="light"&&(w=["#151511dd","#eaa","#151511","#f3f3f3"]),k==="theme1"&&(w=["#151511dd","#eaa","#151511","#f3f3f3"]),k==="theme2"&&(w=["#e5ddeddd","#e2cdec88","#e5dded","#151515"]),w},f=()=>{if(!t.value)return;const k=["dark","theme2"].includes(r.value),w=m();t.value.isDarkMode=k,t.value.setColors(w),t.value.setGridThickness(r.value==="theme1"||r.value==="theme2"?3:1),t.value.strokes&&t.value.strokes.length&&l.value>0?u():(t.value.clearBg(),t.value.draw({progress:1,clearbg:!1}),h({current:0,total:t.value.strokes&&t.value.strokes.length||0}))},v=async()=>{await j();const k=s.value;if(!k){console.error("Canvas element not found.");return}k.width=800,k.height=800,t.value&&(t.value.destroyy(),t.value=null);const w=["dark","theme2"].includes(r.value);if(!c.value){console.error("No stroke data provided for character:",e.character);return}let S=r.value==="theme1"||r.value==="theme2"?3:1,T=e.strokes.medians||[],D=e.strokes.strokes||[];t.value=new nt({strokes:T,masks:D,character:e.character,canvas:k,dimension:k.width,speed:e.animSpeed,lineThickness:e.drawThin?1:8*k.width/200,gridThickness:S,colors:m(),showDiagonals:!0,showGrid:!1,useMask:!0,blendMode:"normal"}),t.value.onStrokeProgress=(I,ct)=>h({current:I}),t.value.isDarkMode=w,await t.value.loadPromise,t.value.draw({progress:1,clearbg:!0}),l.value=0,h({current:0,total:t.value.strokes&&t.value.strokes.length||0})},p=()=>{if(!t.value)return;const k=t.value.strokes&&t.value.strokes.length||0;k&&(t.value.stopAnimation(),l.value=l.value%k+1,u())},g=()=>{l.value=0,h({current:0})},d=()=>{t.value&&(o.value&&(o.value=!1,t.value.isQuizing=!1,t.value.quizComplete=!1),t.value.stopAnimation(),t.value.animationFrame&&(cancelAnimationFrame(t.value.animationFrame),t.value.animationFrame=null),t.value.strokeAnimationFrame&&(cancelAnimationFrame(t.value.strokeAnimationFrame),t.value.strokeAnimationFrame=null),t.value.interpAnimFrame&&(cancelAnimationFrame(t.value.interpAnimFrame),t.value.interpAnimFrame=null),t.value.demoAnimationFrame&&(cancelAnimationFrame(t.value.demoAnimationFrame),t.value.demoAnimationFrame=null),t.value.isAnimating=!1,t.value.isAnimatingStroke=!1,t.value.isAnimatingInterp=!1,t.value.clearBg(),setTimeout(()=>{var k;if(l.value=0,h({current:0}),typeof((k=t.value)==null?void 0:k.onStrokeProgress)=="function")try{t.value.onStrokeProgress(0,t.value.strokes&&t.value.strokes.length||0)}catch{}t.value.startAnimation()},10))},y=()=>{if(t.value){if(o.value&&t.value.quizComplete){t.value.userStrokes=[],t.value.currentStroke=null,t.value.isQuizing=!0,t.value.quizComplete=!1,t.value.clearBg(),t.value.drawUserStrokes(!0);return}o.value=!0,t.value.stopAnimation(),t.value.animationFrame&&(cancelAnimationFrame(t.value.animationFrame),t.value.animationFrame=null),t.value.strokeAnimationFrame&&(cancelAnimationFrame(t.value.strokeAnimationFrame),t.value.strokeAnimationFrame=null),t.value.interpAnimFrame&&(cancelAnimationFrame(t.value.interpAnimFrame),t.value.interpAnimFrame=null),t.value.isAnimating=!1,t.value.isAnimatingStroke=!1,t.value.isAnimatingInterp=!1,t.value.quiz({onComplete:k=>{t.value.quizComplete=!0,o.value=!0}})}},x=()=>{i.value=new MutationObserver(k=>{k.forEach(w=>{if(w.attributeName==="data-theme"){const S=document.documentElement.getAttribute("data-theme");r.value!==S&&(r.value=S,f())}})}),i.value.observe(document.documentElement,{attributes:!0,attributeFilter:["data-theme"]})};return X(()=>{v(),x()}),R(()=>{var k;(k=i.value)==null||k.disconnect(),t.value&&(e.animatable&&s.value&&(s.value.removeEventListener("click",d),s.value.removeEventListener("touchstart",d)),t.value.destroyy())}),C(()=>e.character,async()=>{t.value&&(e.animatable&&s.value&&(s.value.removeEventListener("click",d),s.value.removeEventListener("touchstart",d)),t.value.destroyy()),o.value=!1,l.value=0,h(),v()}),C(()=>e.strokes,()=>{t.value&&e.strokes&&e.strokes.medians&&(o.value=!1,l.value=0,h(),v())},{deep:!0}),a({plotter:()=>t.value,hasStrokeData:c,playAnimation:d,stepStroke:p,resetStep:g}),{hanziCanvas:s,animateCharacter:d,beginQuizMode:y,stepStroke:p,resetStep:g,plotter:t,hasStrokeData:c}}}),ot={key:0,class:"animated-hanzi"},ht={ref:"hanziCanvas",class:"anim-character"};function lt(e,a,n,s,t,i){return e.hasStrokeData?(W(),N("div",ot,[Y("canvas",ht,null,512)])):Q("",!0)}const mt=q(rt,[["render",lt],["__scopeId","data-v-fc660678"]]);export{mt as default};
