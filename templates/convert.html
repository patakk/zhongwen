<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Domine:wght@400..700&family=Noto+Serif+JP:wght@200..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,200..900;1,200..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:ital,opsz,wght@0,6..12,200..1000;1,6..12,200..1000&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Mono:wght@100..900&family=Nunito+Sans:ital,opsz,wght@0,6..12,200..1000;1,6..12,200..1000&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@200..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=ZCOOL+QingKe+HuangYou&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Zhi+Mang+Xing&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Long+Cang&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Character Grid</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link  rel="stylesheet" href="{{ url_for('static', filename='css/darkmode.css') }}">
    <link  rel="stylesheet" href="{{ url_for('static', filename='css/grid.css') }}">
    <link  rel="stylesheet" href="{{ url_for('static', filename='css/flashcard.css') }}">
    <link  rel="stylesheet" href="{{ url_for('static', filename='css/contextmenu.css') }}">
    <link  rel="stylesheet" href="{{ url_for('static', filename='css/hamburger.css') }}">
    <script src="{{ url_for('static', filename='js/plotter.js') }}"></script>
    <style id="dynamic-styles">
        
    </style>
    <style>
        @font-face {
            font-family: 'Kaiti';
            src: url("{{ url_for('static', filename='fonts/Kaiti.ttf') }}") format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        body {
            font-family: 'Kaiti', sans-serif;
        }

        #flashcard_character, #flashcard_plotter {
            font-family: 'Kaiti', sans-serif;
        }

        label {
            font-size: 1.2em;
        }

        textarea {
            width: 30vw;
            height: 30vh;
            padding: 10px;
            font-size: 1.5em;
            resize: none;
            display: block;
            border: 2px solid #161616;
        }

        textarea.darkmode {
            border: 2px solid #c2c2c2;
        }

        #plotters {
            width: 60vw;
            padding: 10px;
            font-size: 1.1em;
            resize: none;
            display: block;
            background: #eee;
        }

        #plotters.darkmode {
            background: #343434;
            color: rgb(206, 206, 206);
        }

        #plotters.empty {
            background: transparent;
        }

        @media screen and (max-width: 600px) {
            textarea {
                width: 90vw;
            }

            #plotters {
                width: 90vw;
            }
            
        }

        .button {
            padding: 10px 20px;
            background-color: #c2c2c2;
            color: rgb(20, 20, 20);
            cursor: pointer;
            transition: background-color 0.3s;
            border-radius: 0;
            user-select: none;
            display: block;
            margin-top: 10px; 
            width: fit-content; 
        }

        .button.darkmode{
            background-color: #343434;
            color: rgb(206, 206, 206);
        }


        .button:active {
            background-color: #a0b3a1;
        }

        .button.clicked {
            background-color: #ffe341;
            transition: background-color 0s;
            color: rgb(31, 31, 31);
        }

        .slider-container {
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #speedSlider {
            -webkit-appearance: none;
            width: 200px;
            background: transparent;
        }

        #speedSlider::-webkit-slider-thumb {
            -webkit-appearance: none;
            border: none;
            height: 16px;
            width: 16px;
            background: black;
            margin-top: -6px;
            cursor: pointer;
        }


        #speedSlider.darkmode::-webkit-slider-thumb {
            background: rgb(124, 124, 124);
        }

        #speedSlider::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #ddd;
            border: none;
        }

        #speedSlider.darkmode::-webkit-slider-runnable-track {
            background: #464646;
        }

        #speedSlider:focus {
            outline: none;
        }

        canvas.darkmode {
            background-color: transparent;
        }

        span.darkmode {
            background-color: transparent;
        }


    </style>
</head>

{% if darkmode %}
<body class="darkmode">
{% else %}
<body>
{% endif %}
    <h1 id="title">Converter</h1>
    <div class="hamburger" id="hamburgerMenu" style="font-size:22px">
        <span></span>
        <span></span>
        <span></span>
    </div>
    <div class="input-container">
        <!-- <label for="hanziInput">Hanzi Input</label> -->
        <textarea id="hanziInput"></textarea>
        <div class="button" id="submitButton">Submit</div>
        <div class="slider-container">
            <input type="range" id="speedSlider" min="0.5" max="4" step="0.1" value="1">
            <span id="speedValue">1x</span>
        </div>
    </div>
    <div id="plotters" class="empty">

    </div>
    <script>
        const button = document.getElementById('submitButton');
        const input = document.getElementById('hanziInput');
        const plottersElem = document.getElementById('plotters');
        let plotters = [];
        let isMouseDown = false;

        function isHanzi(char) {
            return /[\u4e00-\u9fff]/.test(char);
        }

        function isPunctuation(char) {
            return char === "。" || char === "，" || char === "、" || char === "；" || char === "：";
        }

        document.addEventListener("DOMContentLoaded", function() {
            const speedSlider = document.getElementById('speedSlider');
            const speedValue = document.getElementById('speedValue');

            speedSlider.addEventListener('input', function() {
                speedValue.textContent = this.value + 'x';
            });

            plottersElem.addEventListener('mousedown', function(e) {
                e.preventDefault();
            });
        });

        document.addEventListener("mousedown", function() {
            isMouseDown = true;
        });

        document.addEventListener("mouseup", function() {
            isMouseDown = false;
        });

        document.addEventListener("mousemove", function(e) {
            if(isMouseDown){
                const plotterIndex = e.target.dataset.plotterIndex;
                if(plotterIndex !== undefined){
                    plotters[plotterIndex].plotter.canvas.click();
                }
            }
        });

        button.addEventListener('click', function() {
            button.classList.add('clicked');
            plottersElem.classList.remove('empty');

            let characters = input.value.split('');
            const plotterElement = document.getElementById('plotters');
            plotterElement.innerHTML = '';
            plotters = [];

            let size = 124;
            if(isMobileOrTablet()){
                console.log('Mobile or tablet detected');
                size = 48;
            }
            characters.forEach(char => {
                if(isHanzi(char) && !isPunctuation(char)){
                    try{
                        const plotter = new HanziPlotter({char, size: size, animateOnClick: true, speedSlider: document.getElementById('speedSlider')});
                        plotters.push({plotter: plotter, char: char});
                    }
                    catch(e){
                    }
                }
                else{
                    plotters.push({plotter: null, char: char});
                    if(isPunctuation(char) || char === '\n'){
                        plotters.push({plotter: null, char: '<br>'});
                    }
                }
            });

            
            if(plotterElement && plotters){
                plotterElement.innerHTML = '';
                // Store plotters as a property of the container element
                // plotterElement.plotters = plotters;
                plotterElement.plotters = plotters;
                
                plotters.forEach((plotterinfo, index) => {
                    let plotter = plotterinfo.plotter;
                    if(plotter){
                        plotter.ctx.lineWidth = 2;
                        plotter.draw(document.getElementById('speedSlider').value);
                        plotter.canvas.dataset.plotterIndex = index;
                        plotterElement.appendChild(plotter.canvas);
                    }
                    else{
                        let latin = document.createElement('span');
                        latin.innerHTML = plotterinfo.char;
                        if(isMobileOrTablet()){
                            latin.style.fontSize = '2.5em';
                        }
                        else{
                            latin.style.fontSize = '6em';
                        }
                        plotterElement.appendChild(latin);
                    }
                });
            }


            setTimeout(() => {
                button.classList.remove('clicked');
            }, 400);
        });
            
    </script>

    <div class="dropdown-menu" id="dropdownMenu">
        <ul>
            <li id="loginMenuItem"><a href="{{ url_for('login') }}">Login</a></li>
            <li><a href="{{ url_for('home') }}">Home</a></li>
            <li class="has-submenu">
                <span>Hanzi Grid</span>
                <ul class="submenu">
                    {% for key, deck in decks.items() %}
                        <li><a class="deck-option" data-deck="{{ key }}">{{ deck.name }}</a></li>
                    {% endfor %}
                </ul>
            </li>
            <li class="has-submenu">
                <span>Flashcards</span>
                <ul class="submenu">
                    {% for key, deck in decks.items() %}
                        <li><a href="{{ url_for('flashcards') }}?deck={{ key }}">{{ deck.name }}</a></li>
                        {% endfor %}
                </ul>
            </li>
            <li><a href="{{ url_for('lists') }}">Example Lists</a></li>
            <li><a href="{{ url_for('puzzles.puzzles') }}">Puzzles</a></li>
            <li><a href="{{ url_for('hanzipractice') }}">Practice 汉字</a></li>
            <li><a href="{{ url_for('search') }}">Search</a></li>
            <li class="has-submenu">
                <span>Fonts</span>
                <ul class="submenu">
                    <li><a href="#" class="font-change" data-font="Noto Sans Mono">Noto Sans Mono</a></li>
                    <li><a href="#" class="font-change" data-font="Noto Serif SC">Noto Serif SC</a></li>
                    <li><a href="#" class="font-change" data-font="Kaiti">Kaiti</a></li>
                    <!-- <li><a href="#" class="font-change" data-font="Render">Render</a></li> -->
                </ul>
            </li>
            <li><span id="darkmode-toggle" >Toggle darkmode</span></li>
            <li><a href="{{ url_for('pageinfo') }}">Info</a></li>
            <li><a href="{{ url_for('logout') }}" id="logoutButton">Logout</a></li>
        </ul>
    </div>

    <script>
        const inputdecks = {{ decks | tojson | safe }};        
        let inputdeck = {{ deck | tojson | safe }};
        let isDarkMode = {{ darkmode | tojson | safe }};
        const username = {{ username | tojson | safe }};
    </script>
    <script>
        
        function isMobileOrTablet() {
            let check = false;
            (function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4))) check = true;})(navigator.userAgent||navigator.vendor||window.opera);
            return check || /iPad|iPhone|iPod/.test(navigator.platform) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        }
    </script>
    <script src="{{ url_for('static', filename='js/perlin.js') }}"></script>
    <script src="{{ url_for('static', filename='js/hamburger.js') }}"></script>
    <script src="{{ url_for('static', filename='js/darkmode.js') }}"></script>
</body>
</html>