const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-D9NOukqS.js","assets/_commonjsHelpers-Cpj98o6Y.js"])))=>i.map(i=>d[i]);
import{_ as S,P as _,r as R,c as l,o as c,a,b as g,w as d,n as w,d as k,F as O,e as P,f as T,g as D,t as M,h as L}from"./index-BVrhDxcK.js";let x=null;const F={name:"OcrPanel",emits:["insert-text"],data(){return{file:null,fileName:"",previewUrl:"",isDragOver:!1,isProcessing:!1,isReady:!1,progressValue:0,statusMessage:"Loading OCR engine...",progressMessage:"",error:"",ocrText:"",tesseract:null,hasOcrResult:!1,showCropper:!1,cropSelection:null,cropSelecting:!1,cropImageDims:{displayWidth:0,displayHeight:0,offsetX:0,offsetY:0}}},components:{PreloadWrapper:_},computed:{progressPercent(){if(!this.progressValue)return 0;const t=Math.round(this.progressValue*100);return Math.min(100,Math.max(0,t))},cropStyle(){if(!this.cropSelection)return{};const{x:t,y:e,w:o,h:n}=this.normalizedSelection(),{offsetX:i=0,offsetY:s=0}=this.cropImageDims||{};return{left:`${i+t}px`,top:`${s+e}px`,width:`${o}px`,height:`${n}px`}},runButtonStyle(){const t=this.progressPercent||0;return{backgroundImage:`linear-gradient(90deg, color-mix(in oklab, var(--fg) 80%, var(--bg) 15%) ${t}%, color-mix(in oklab, var(--fg) 70%, var(--bg) 25%) ${t}%)`}},ocrTokens(){const t=this.cleanOcrText(this.ocrText);if(!t)return[];const e=new Set(t.split(/\s+/).filter(Boolean));return Array.from(e)},ocrTokenObjects(){return this.ocrTokens.map(t=>({character:t}))},ocrNavList(){return this.ocrTokenObjects.map(t=>t.character)}},async mounted(){await this.ensureLibLoaded()},beforeUnmount(){this.previewUrl&&URL.revokeObjectURL(this.previewUrl)},methods:{handleFileChange(t){const[e]=t.target.files||[];this.setFile(e)},handleDrop(t){var o;this.isDragOver=!1;const[e]=((o=t.dataTransfer)==null?void 0:o.files)||[];this.setFile(e)},openFilePicker(){this.$refs.fileInput&&this.$refs.fileInput.click()},setFile(t){t&&(this.previewUrl&&URL.revokeObjectURL(this.previewUrl),this.file=t,this.fileName=t.name,this.previewUrl=URL.createObjectURL(t),this.error="",this.ocrText="",this.progressValue=0,this.progressMessage="",this.hasOcrResult=!1,this.showCropper=!1)},openCropper(){this.previewUrl&&(this.showCropper=!0,this.$nextTick(()=>this.initCropSelection()))},closeCropper(){this.showCropper=!1,this.cropSelecting=!1},initCropSelection(){const t=this.$refs.cropImg;if(!t)return;const e=t.getBoundingClientRect(),{width:o,height:n}=e,i=this.$refs.cropStage,s=i?i.getBoundingClientRect():e;let p=0,r=0;if(i){const y=getComputedStyle(i),v=parseFloat(y.borderLeftWidth||"0"),C=parseFloat(y.borderTopWidth||"0");p=parseFloat(y.paddingLeft||"0")+v,r=parseFloat(y.paddingTop||"0")+C}const h=e.left-s.left-p,f=e.top-s.top-r;this.cropImageDims={displayWidth:o,displayHeight:n,offsetX:h,offsetY:f};const m=Math.min(o,n)*.7,u=Math.max(0,(o-m)/2),b=Math.max(0,(n-m)/2);this.cropSelection={x:u,y:b,w:m,h:m},this.$nextTick(()=>{this.cropSelection=this.normalizedSelection()})},pointerPos(t){var h,f;const e=this.$refs.cropStage;if(!e)return null;const o=e.getBoundingClientRect(),n=getComputedStyle(e),i=parseFloat(n.paddingLeft||"0")+parseFloat(n.borderLeftWidth||"0")+2,s=parseFloat(n.paddingTop||"0")+parseFloat(n.borderTopWidth||"0")+2,p=t.clientX??(t.touches&&((h=t.touches[0])==null?void 0:h.clientX)),r=t.clientY??(t.touches&&((f=t.touches[0])==null?void 0:f.clientY));return p===void 0||r===void 0?null:{x:p-o.left-i,y:r-o.top-s}},startCrop(t){const e=this.pointerPos(t);if(!e)return;const{offsetX:o=0,offsetY:n=0,displayWidth:i,displayHeight:s}=this.cropImageDims||{},p=Math.max(0,Math.min(e.x-o,i)),r=Math.max(0,Math.min(e.y-n,s));this.cropSelecting=!0,this.cropSelection={x:p,y:r,w:0,h:0}},onCropMove(t){if(!this.cropSelecting||!this.cropSelection)return;const e=this.pointerPos(t);if(!e)return;const{offsetX:o=0,offsetY:n=0,displayWidth:i,displayHeight:s}=this.cropImageDims||{},p=Math.max(0,Math.min(e.x-o,i)),r=Math.max(0,Math.min(e.y-n,s));this.cropSelection={...this.cropSelection,w:p-this.cropSelection.x,h:r-this.cropSelection.y}},endCrop(){this.cropSelecting&&(this.cropSelecting=!1,this.cropSelection=this.normalizedSelection())},clampToImage(t){const{displayWidth:e=0,displayHeight:o=0}=this.cropImageDims||{};return{x:Math.max(0,Math.min(t.x,e)),y:Math.max(0,Math.min(t.y,o))}},normalizedSelection(){if(!this.cropSelection)return null;let{x:t,y:e,w:o,h:n}=this.cropSelection;o<0&&(t+=o,o=Math.abs(o)),n<0&&(e+=n,n=Math.abs(n));const i=this.cropImageDims.displayWidth||o,s=this.cropImageDims.displayHeight||n;return t=Math.max(0,Math.min(t,i)),e=Math.max(0,Math.min(e,s)),o=Math.min(o,i-t),n=Math.min(n,s-e),{x:t,y:e,w:o,h:n}},cleanOcrText(t){return t?t.replace(/[^\p{Script=Han}\s]/gu,"").replace(/\s+/g," ").trim():""},async applyCrop(){var y;const t=this.$refs.cropImg;if(!t||!this.cropSelection)return;const e=this.normalizedSelection();if(!e||!e.w||!e.h){this.closeCropper();return}const o=t.naturalWidth||t.width,n=t.naturalHeight||t.height,i=t.getBoundingClientRect(),s=o/i.width,p=n/i.height,r=e.x*s,h=e.y*p,f=e.w*s,m=e.h*p,u=document.createElement("canvas");u.width=Math.max(1,Math.round(f)),u.height=Math.max(1,Math.round(m)),u.getContext("2d").drawImage(t,r,h,f,m,0,0,u.width,u.height),u.toBlob(v=>{if(!v){this.closeCropper();return}const C=new File([v],this.fileName||"ocr-crop.png",{type:v.type});this.setFile(C),this.closeCropper()},((y=this.file)==null?void 0:y.type)||"image/png")},async ensureLibLoaded(){if(x){this.tesseract=x,this.isReady=!0,this.statusMessage="";return}if(!this.tesseract){this.isReady=!1,this.statusMessage="Loading OCR engine...";try{const t=await L(()=>import("./index-D9NOukqS.js").then(e=>e.i),__vite__mapDeps([0,1]));if(this.tesseract=t!=null&&t.recognize?t:t.default,!this.tesseract||!this.tesseract.recognize)throw new Error("Tesseract recognize not available");x=this.tesseract,this.isReady=!0,this.statusMessage="Ready",setTimeout(()=>{this.statusMessage==="Ready"&&(this.statusMessage="")},800)}catch(t){console.error("Failed to load tesseract",t),this.error="Unable to load OCR tools. Please retry.",this.statusMessage=""}}},handleProgress(t){t&&(t.progress!==void 0&&(this.progressValue=t.progress),t.status&&(this.progressMessage=`${t.status} ${t.progress?Math.round(t.progress*100)+"%":""}`.trim()))},async runOcr(){if(!this.file){this.error="Choose an image to start.";return}if(await this.ensureLibLoaded(),!!this.tesseract){this.isProcessing=!0,this.error="",this.ocrText="",this.progressValue=0,this.progressMessage="Preparing...",this.hasOcrResult=!1;try{const{data:t}=await this.tesseract.recognize(this.file,"chi_sim",{logger:o=>this.handleProgress(o)}),e=((t==null?void 0:t.text)||"").trim();this.ocrText=this.cleanOcrText(e),this.progressValue=1,this.progressMessage="Done",this.hasOcrResult=!0,this.ocrText&&this.emitToSearch()}catch(t){console.error("OCR failed",t),this.error="OCR failed. Please try a clearer image or retry."}finally{this.isProcessing=!1}}},emitToSearch(){this.ocrText&&this.$emit("insert-text",this.ocrText.trim())},async copyToken(t){if(!(!t||!(navigator!=null&&navigator.clipboard)))try{await navigator.clipboard.writeText(t)}catch(e){console.error("Copy failed",e)}}}},I={class:"ocr-panel-container"},U={class:"ocr-panel"},W={class:"input-row"},B={class:"drop-area-wrapper"},z={key:0,class:"drop-copy"},X={key:0,class:"drop-title"},Y={key:1,class:"drop-hint"},H={key:1,class:"preview"},N=["src"],V={key:2,class:"drop-actions"},j=["disabled"],E={key:0},A={key:1},G={key:2},q={class:"result result-wrapper"},J={class:"result-body stroke-result"},K={key:0,class:"stroke-label"},Q={key:1,class:"stroke-result-list"},Z={class:"stroke-result-text"},$={key:0,class:"error"},ee={key:0,class:"crop-modal"},te={class:"crop-dialog"},se={class:"crop-header"},re=["src"],ie={class:"crop-actions"},oe=["disabled"];function ne(t,e,o,n,i,s){const p=R("PreloadWrapper");return c(),l("div",I,[a("div",U,[a("div",W,[a("div",B,[a("div",{class:w(["drop-area",{"is-active":i.isDragOver}]),onDragover:e[3]||(e[3]=d(r=>i.isDragOver=!0,["prevent"])),onDragleave:e[4]||(e[4]=d(r=>i.isDragOver=!1,["prevent"])),onDrop:e[5]||(e[5]=d((...r)=>s.handleDrop&&s.handleDrop(...r),["prevent"])),onClick:e[6]||(e[6]=(...r)=>s.openFilePicker&&s.openFilePicker(...r))},[a("input",{ref:"fileInput",type:"file",accept:"image/*",class:"file-input",onChange:e[0]||(e[0]=(...r)=>s.handleFileChange&&s.handleFileChange(...r))},null,544),i.file?g("",!0):(c(),l("div",z,[i.file?g("",!0):(c(),l("div",X,"Drop an image or click to choose")),i.file?g("",!0):(c(),l("div",Y,"PNG, JPG, screenshots. Nothing is uploaded to our servers."))])),i.previewUrl?(c(),l("div",H,[a("img",{src:i.previewUrl,alt:"Selected for OCR"},null,8,N)])):g("",!0),i.file?(c(),l("div",V,[a("button",{type:"button",class:"crop-btn",onClick:e[1]||(e[1]=d((...r)=>s.openCropper&&s.openCropper(...r),["stop"]))}," Crop image "),a("button",{type:"button",class:w(["btn-primary run-btn",{processing:i.isProcessing}]),onClick:e[2]||(e[2]=d((...r)=>s.runOcr&&s.runOcr(...r),["stop"])),disabled:!i.file||i.isProcessing||!i.isReady,style:k(s.runButtonStyle)},[i.isProcessing?(c(),l("span",E,"Running OCR...")):i.isReady?(c(),l("span",G,"Run OCR")):(c(),l("span",A,"Preparing OCR..."))],14,j)])):g("",!0)],34)]),a("div",q,[e[15]||(e[15]=a("div",{class:"result-header"},[a("div",{class:"result-title"},"Detected words")],-1)),a("div",J,[s.ocrTokenObjects.length?(c(),l("div",Q,[(c(!0),l(O,null,P(s.ocrTokenObjects,(r,h)=>(c(),T(p,{key:r.character||h,character:r.character,navList:s.ocrNavList,navIndex:h,showBubbles:!1,class:"stroke-result-btn"},{default:D(()=>[a("span",Z,M(r.character),1)]),_:2},1032,["character","navList","navIndex"]))),128))])):(c(),l("div",K,"No text detected."))])])]),i.error?(c(),l("div",$,M(i.error),1)):g("",!0)]),i.showCropper?(c(),l("div",ee,[a("div",te,[a("div",se,[e[16]||(e[16]=a("div",null,[a("div",{class:"crop-title"},"Crop image"),a("div",{class:"crop-subtitle"},"Drag to select the area to OCR.")],-1)),a("button",{type:"button",class:"chip",onClick:e[7]||(e[7]=(...r)=>s.closeCropper&&s.closeCropper(...r))},"Cancel")]),a("div",{class:"crop-stage",ref:"cropStage",onPointerdown:e[9]||(e[9]=d((...r)=>s.startCrop&&s.startCrop(...r),["prevent"])),onPointermove:e[10]||(e[10]=d((...r)=>s.onCropMove&&s.onCropMove(...r),["prevent"])),onPointerup:e[11]||(e[11]=d((...r)=>s.endCrop&&s.endCrop(...r),["prevent"])),onPointerleave:e[12]||(e[12]=d((...r)=>s.endCrop&&s.endCrop(...r),["prevent"]))},[a("img",{ref:"cropImg",src:i.previewUrl,alt:"Crop",onLoad:e[8]||(e[8]=(...r)=>s.initCropSelection&&s.initCropSelection(...r))},null,40,re),i.cropSelection?(c(),l("div",{key:0,class:"crop-rect",style:k(s.cropStyle)},null,4)):g("",!0)],544),a("div",ie,[a("button",{type:"button",class:"btn-secondary",onClick:e[13]||(e[13]=(...r)=>s.closeCropper&&s.closeCropper(...r))},"Back"),a("button",{type:"button",class:"btn-primary",onClick:e[14]||(e[14]=(...r)=>s.applyCrop&&s.applyCrop(...r)),disabled:!i.cropSelection||i.isProcessing}," Apply crop ",8,oe)])])])):g("",!0)])}const ce=S(F,[["render",ne],["__scopeId","data-v-df644841"]]);export{ce as default};
