const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-D9NOukqS.js","assets/_commonjsHelpers-Cpj98o6Y.js"])))=>i.map(i=>d[i]);
import{_ as k,c as a,o as c,a as l,b as h,w as d,n as w,d as M,F as _,r as R,t as S,e as O}from"./index-D92RLklE.js";let x=null;const T={name:"OcrPanel",emits:["insert-text"],data(){return{file:null,fileName:"",previewUrl:"",isDragOver:!1,isProcessing:!1,isReady:!1,progressValue:0,statusMessage:"Loading OCR engine...",progressMessage:"",error:"",ocrText:"",tesseract:null,hasOcrResult:!1,showCropper:!1,cropSelection:null,cropSelecting:!1,cropImageDims:{displayWidth:0,displayHeight:0,offsetX:0,offsetY:0}}},computed:{progressPercent(){if(!this.progressValue)return 0;const t=Math.round(this.progressValue*100);return Math.min(100,Math.max(0,t))},cropStyle(){if(!this.cropSelection)return{};const{x:t,y:e,w:o,h:n}=this.normalizedSelection(),{offsetX:r=0,offsetY:s=0}=this.cropImageDims||{};return{left:`${r+t}px`,top:`${s+e}px`,width:`${o}px`,height:`${n}px`}},runButtonStyle(){const t=this.progressPercent||0;return{backgroundImage:`linear-gradient(90deg, color-mix(in oklab, var(--fg) 80%, var(--bg) 15%) ${t}%, color-mix(in oklab, var(--fg) 70%, var(--bg) 25%) ${t}%)`}},ocrTokens(){const t=this.cleanOcrText(this.ocrText);if(!t)return[];const e=new Set(t.split(/\s+/).filter(Boolean));return Array.from(e)}},async mounted(){await this.ensureLibLoaded()},beforeUnmount(){this.previewUrl&&URL.revokeObjectURL(this.previewUrl)},methods:{handleFileChange(t){const[e]=t.target.files||[];this.setFile(e)},handleDrop(t){var o;this.isDragOver=!1;const[e]=((o=t.dataTransfer)==null?void 0:o.files)||[];this.setFile(e)},openFilePicker(){this.$refs.fileInput&&this.$refs.fileInput.click()},setFile(t){t&&(this.previewUrl&&URL.revokeObjectURL(this.previewUrl),this.file=t,this.fileName=t.name,this.previewUrl=URL.createObjectURL(t),this.error="",this.ocrText="",this.progressValue=0,this.progressMessage="",this.hasOcrResult=!1,this.showCropper=!1)},openCropper(){this.previewUrl&&(this.showCropper=!0,this.$nextTick(()=>this.initCropSelection()))},closeCropper(){this.showCropper=!1,this.cropSelecting=!1},initCropSelection(){const t=this.$refs.cropImg;if(!t)return;const e=t.getBoundingClientRect(),{width:o,height:n}=e,r=this.$refs.cropStage,s=r?r.getBoundingClientRect():e;let i=0,p=0;if(r){const y=getComputedStyle(r),C=parseFloat(y.borderLeftWidth||"0"),v=parseFloat(y.borderTopWidth||"0");i=parseFloat(y.paddingLeft||"0")+C,p=parseFloat(y.paddingTop||"0")+v}const g=e.left-s.left-i,f=e.top-s.top-p;this.cropImageDims={displayWidth:o,displayHeight:n,offsetX:g,offsetY:f};const m=Math.min(o,n)*.7,u=Math.max(0,(o-m)/2),b=Math.max(0,(n-m)/2);this.cropSelection={x:u,y:b,w:m,h:m},this.$nextTick(()=>{this.cropSelection=this.normalizedSelection()})},pointerPos(t){var g,f;const e=this.$refs.cropStage;if(!e)return null;const o=e.getBoundingClientRect(),n=getComputedStyle(e),r=parseFloat(n.paddingLeft||"0")+parseFloat(n.borderLeftWidth||"0")+2,s=parseFloat(n.paddingTop||"0")+parseFloat(n.borderTopWidth||"0")+2,i=t.clientX??(t.touches&&((g=t.touches[0])==null?void 0:g.clientX)),p=t.clientY??(t.touches&&((f=t.touches[0])==null?void 0:f.clientY));return i===void 0||p===void 0?null:{x:i-o.left-r,y:p-o.top-s}},startCrop(t){const e=this.pointerPos(t);if(!e)return;const{offsetX:o=0,offsetY:n=0,displayWidth:r,displayHeight:s}=this.cropImageDims||{},i=Math.max(0,Math.min(e.x-o,r)),p=Math.max(0,Math.min(e.y-n,s));this.cropSelecting=!0,this.cropSelection={x:i,y:p,w:0,h:0}},onCropMove(t){if(!this.cropSelecting||!this.cropSelection)return;const e=this.pointerPos(t);if(!e)return;const{offsetX:o=0,offsetY:n=0,displayWidth:r,displayHeight:s}=this.cropImageDims||{},i=Math.max(0,Math.min(e.x-o,r)),p=Math.max(0,Math.min(e.y-n,s));this.cropSelection={...this.cropSelection,w:i-this.cropSelection.x,h:p-this.cropSelection.y}},endCrop(){this.cropSelecting&&(this.cropSelecting=!1,this.cropSelection=this.normalizedSelection())},clampToImage(t){const{displayWidth:e=0,displayHeight:o=0}=this.cropImageDims||{};return{x:Math.max(0,Math.min(t.x,e)),y:Math.max(0,Math.min(t.y,o))}},normalizedSelection(){if(!this.cropSelection)return null;let{x:t,y:e,w:o,h:n}=this.cropSelection;o<0&&(t+=o,o=Math.abs(o)),n<0&&(e+=n,n=Math.abs(n));const r=this.cropImageDims.displayWidth||o,s=this.cropImageDims.displayHeight||n;return t=Math.max(0,Math.min(t,r)),e=Math.max(0,Math.min(e,s)),o=Math.min(o,r-t),n=Math.min(n,s-e),{x:t,y:e,w:o,h:n}},cleanOcrText(t){return t?t.replace(/[^\p{Script=Han}\s]/gu,"").replace(/\s+/g," ").trim():""},async applyCrop(){var y;const t=this.$refs.cropImg;if(!t||!this.cropSelection)return;const e=this.normalizedSelection();if(!e||!e.w||!e.h){this.closeCropper();return}const o=t.naturalWidth||t.width,n=t.naturalHeight||t.height,r=t.getBoundingClientRect(),s=o/r.width,i=n/r.height,p=e.x*s,g=e.y*i,f=e.w*s,m=e.h*i,u=document.createElement("canvas");u.width=Math.max(1,Math.round(f)),u.height=Math.max(1,Math.round(m)),u.getContext("2d").drawImage(t,p,g,f,m,0,0,u.width,u.height),u.toBlob(C=>{if(!C){this.closeCropper();return}const v=new File([C],this.fileName||"ocr-crop.png",{type:C.type});this.setFile(v),this.closeCropper()},((y=this.file)==null?void 0:y.type)||"image/png")},async ensureLibLoaded(){if(x){this.tesseract=x,this.isReady=!0,this.statusMessage="";return}if(!this.tesseract){this.isReady=!1,this.statusMessage="Loading OCR engine...";try{const t=await O(()=>import("./index-D9NOukqS.js").then(e=>e.i),__vite__mapDeps([0,1]));if(this.tesseract=t!=null&&t.recognize?t:t.default,!this.tesseract||!this.tesseract.recognize)throw new Error("Tesseract recognize not available");x=this.tesseract,this.isReady=!0,this.statusMessage="Ready",setTimeout(()=>{this.statusMessage==="Ready"&&(this.statusMessage="")},800)}catch(t){console.error("Failed to load tesseract",t),this.error="Unable to load OCR tools. Please retry.",this.statusMessage=""}}},handleProgress(t){t&&(t.progress!==void 0&&(this.progressValue=t.progress),t.status&&(this.progressMessage=`${t.status} ${t.progress?Math.round(t.progress*100)+"%":""}`.trim()))},async runOcr(){if(!this.file){this.error="Choose an image to start.";return}if(await this.ensureLibLoaded(),!!this.tesseract){this.isProcessing=!0,this.error="",this.ocrText="",this.progressValue=0,this.progressMessage="Preparing...",this.hasOcrResult=!1;try{const{data:t}=await this.tesseract.recognize(this.file,"chi_sim",{logger:o=>this.handleProgress(o)}),e=((t==null?void 0:t.text)||"").trim();this.ocrText=this.cleanOcrText(e),this.progressValue=1,this.progressMessage="Done",this.hasOcrResult=!0,this.ocrText&&this.emitToSearch()}catch(t){console.error("OCR failed",t),this.error="OCR failed. Please try a clearer image or retry."}finally{this.isProcessing=!1}}},emitToSearch(){this.ocrText&&this.$emit("insert-text",this.ocrText.trim())},async copyToken(t){if(!(!t||!(navigator!=null&&navigator.clipboard)))try{await navigator.clipboard.writeText(t)}catch(e){console.error("Copy failed",e)}}}},P={class:"ocr-panel-container"},D={class:"ocr-panel"},F={class:"input-row"},L={class:"drop-area-wrapper"},I={key:0,class:"drop-copy"},U={key:0,class:"drop-title"},W={key:1,class:"drop-hint"},z={key:1,class:"preview"},B=["src"],X={key:2,class:"drop-actions"},Y=["disabled"],H={key:0},V={key:1},N={key:2},E={key:0,class:"result result-wrapper"},j={class:"result-body token-body"},A={key:0,class:"token-empty"},G={key:1,class:"token-list"},q=["onClick"],J={class:"stroke-result-text"},K={key:0,class:"error"},Q={key:0,class:"crop-modal"},Z={class:"crop-dialog"},$={class:"crop-header"},ee=["src"],te={class:"crop-actions"},se=["disabled"];function re(t,e,o,n,r,s){return c(),a("div",P,[l("div",D,[l("div",F,[l("div",L,[l("div",{class:w(["drop-area",{"is-active":r.isDragOver}]),onDragover:e[3]||(e[3]=d(i=>r.isDragOver=!0,["prevent"])),onDragleave:e[4]||(e[4]=d(i=>r.isDragOver=!1,["prevent"])),onDrop:e[5]||(e[5]=d((...i)=>s.handleDrop&&s.handleDrop(...i),["prevent"])),onClick:e[6]||(e[6]=(...i)=>s.openFilePicker&&s.openFilePicker(...i))},[l("input",{ref:"fileInput",type:"file",accept:"image/*",class:"file-input",onChange:e[0]||(e[0]=(...i)=>s.handleFileChange&&s.handleFileChange(...i))},null,544),r.file?h("",!0):(c(),a("div",I,[r.file?h("",!0):(c(),a("div",U,"Drop an image or click to choose")),r.file?h("",!0):(c(),a("div",W,"PNG, JPG, screenshots. Nothing is uploaded to our servers."))])),r.previewUrl?(c(),a("div",z,[l("img",{src:r.previewUrl,alt:"Selected for OCR"},null,8,B)])):h("",!0),r.file?(c(),a("div",X,[l("button",{type:"button",class:"crop-btn",onClick:e[1]||(e[1]=d((...i)=>s.openCropper&&s.openCropper(...i),["stop"]))}," Crop image "),l("button",{type:"button",class:w(["btn-primary run-btn",{processing:r.isProcessing}]),onClick:e[2]||(e[2]=d((...i)=>s.runOcr&&s.runOcr(...i),["stop"])),disabled:!r.file||r.isProcessing||!r.isReady,style:M(s.runButtonStyle)},[r.isProcessing?(c(),a("span",H,"Running OCR...")):r.isReady?(c(),a("span",N,"Run OCR")):(c(),a("span",V,"Preparing OCR..."))],14,Y)])):h("",!0)],34)]),r.hasOcrResult||r.ocrText?(c(),a("div",E,[e[15]||(e[15]=l("div",{class:"result-header"},[l("div",{class:"result-title"},"Detected words")],-1)),l("div",j,[s.ocrTokens.length?(c(),a("div",G,[(c(!0),a(_,null,R(s.ocrTokens,(i,p)=>(c(),a("button",{key:p,type:"button",class:"stroke-result-btn ocr-result-btn",onClick:g=>s.copyToken(i)},[l("span",J,S(i),1)],8,q))),128))])):(c(),a("div",A,"No text detected."))])])):h("",!0)]),r.error?(c(),a("div",K,S(r.error),1)):h("",!0)]),r.showCropper?(c(),a("div",Q,[l("div",Z,[l("div",$,[e[16]||(e[16]=l("div",null,[l("div",{class:"crop-title"},"Crop image"),l("div",{class:"crop-subtitle"},"Drag to select the area to OCR.")],-1)),l("button",{type:"button",class:"chip",onClick:e[7]||(e[7]=(...i)=>s.closeCropper&&s.closeCropper(...i))},"Cancel")]),l("div",{class:"crop-stage",ref:"cropStage",onPointerdown:e[9]||(e[9]=d((...i)=>s.startCrop&&s.startCrop(...i),["prevent"])),onPointermove:e[10]||(e[10]=d((...i)=>s.onCropMove&&s.onCropMove(...i),["prevent"])),onPointerup:e[11]||(e[11]=d((...i)=>s.endCrop&&s.endCrop(...i),["prevent"])),onPointerleave:e[12]||(e[12]=d((...i)=>s.endCrop&&s.endCrop(...i),["prevent"]))},[l("img",{ref:"cropImg",src:r.previewUrl,alt:"Crop",onLoad:e[8]||(e[8]=(...i)=>s.initCropSelection&&s.initCropSelection(...i))},null,40,ee),r.cropSelection?(c(),a("div",{key:0,class:"crop-rect",style:M(s.cropStyle)},null,4)):h("",!0)],544),l("div",te,[l("button",{type:"button",class:"btn-secondary",onClick:e[13]||(e[13]=(...i)=>s.closeCropper&&s.closeCropper(...i))},"Back"),l("button",{type:"button",class:"btn-primary",onClick:e[14]||(e[14]=(...i)=>s.applyCrop&&s.applyCrop(...i)),disabled:!r.cropSelection||r.isProcessing}," Apply crop ",8,se)])])])):h("",!0)])}const oe=k(T,[["render",re],["__scopeId","data-v-5b10172f"]]);export{oe as default};
